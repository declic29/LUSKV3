{% extends "simple/base.html" %}

{% block content %}
<div class="index">
  <!-- Votre contenu existant -->
  <div id="news-container" style="margin: 30px auto; max-width: 900px;">
    <h2 style="text-align: center; margin-bottom: 25px; font-size: 1.5rem;">Actualit√©s Bretonnes</h2>
    <div id="news-results" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; padding: 0 15px;"></div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Version avec debug complet
document.addEventListener('DOMContentLoaded', async function() {
    console.log("[DEBUG] Initialisation du module d'actualit√©s");
    const apiKey = '2a28af6c4ebc58d5beba1fc150c105eb';
    
    if (!apiKey) {
        console.error("[ERREUR] Aucune cl√© API d√©finie");
        return;
    }
    
    try {
        await fetchBretonNews(apiKey);
    } catch (error) {
        console.error("[ERREUR CRITIQUE]", error);
    }
});

async function fetchBretonNews(apiKey) {
    const container = document.getElementById('news-results');
    if (!container) {
        console.error("[ERREUR] √âl√©ment #news-results introuvable");
        return;
    }

    // Afficher le loader
    container.innerHTML = `
        <div style="grid-column: 1/-1; text-align: center;">
            <div class="news-loader"></div>
            <p>Recherche des derni√®res actualit√©s bretonnes...</p>
        </div>
    `;

    try {
        // 1. Test direct de l'API
        console.log("[DEBUG] Test de l'API GNews...");
        const testUrl = `https://gnews.io/api/v4/top-headlines?token=${apiKey}&lang=fr&q=Bretagne`;
        const testResponse = await fetch(testUrl);
        
        if (!testResponse.ok) {
            throw new Error(`Erreur API: ${testResponse.status} ${testResponse.statusText}`);
        }
        
        const testData = await testResponse.json();
        console.log("[DEBUG] R√©ponse API test:", testData);

        // 2. Requ√™te principale
        const query = encodeURIComponent("Bretagne OR (Rennes AND actualit√©) OR Finist√®re OR Morbihan");
        const mainUrl = `https://gnews.io/api/v4/top-headlines?token=${apiKey}&lang=fr&q=${query}`;
        console.log("[DEBUG] Requ√™te principale:", mainUrl);
        
        const response = await fetch(mainUrl);
        const data = await response.json();
        console.log("[DEBUG] Donn√©es re√ßues:", data);

        if (!data.articles || data.articles.length === 0) {
            throw new Error("Aucun article trouv√©");
        }

        // Filtre breton strict
        const bretonArticles = data.articles.filter(article => {
            const titleMatch = article.title?.match(/Bretagne|Breton|Rennes|Brest|Quimper|Vannes|Saint-Brieuc|Lorient|Morbihan|Finist√®re|C√¥tes-d'Armor|Ille-et-Vilaine/i);
            const descMatch = article.description?.match(/Bretagne|Breton|Rennes|Brest|Quimper|Vannes|Saint-Brieuc|Lorient|Morbihan|Finist√®re|C√¥tes-d'Armor|Ille-et-Vilaine/i);
            return titleMatch || descMatch;
        });

        console.log("[DEBUG] Articles bretons filtr√©s:", bretonArticles);

        if (bretonArticles.length === 0) {
            container.innerHTML = `
                <div style="grid-column: 1/-1; text-align: center; padding: 20px;">
                    <p>Nous n'avons trouv√© aucune actualit√© bretonne r√©cente.</p>
                    <small>Essayez de rafra√Æchir la page dans quelques minutes.</small>
                </div>
            `;
            return;
        }

        // Affichage des r√©sultats
        container.innerHTML = bretonArticles.slice(0, 6).map(article => `
            <a href="${article.url}" target="_blank" rel="noopener noreferrer" class="news-card">
                <div class="news-image-container">
                    ${article.image ? `
                    <img src="${article.image}" 
                         alt="${article.title}" 
                         class="news-image"
                         loading="lazy">` 
                    : '<div class="news-image-placeholder">üñºÔ∏è</div>'}
                </div>
                <div class="news-content">
                    <h3>${highlightBretonTerms(article.title)}</h3>
                    <p>${highlightBretonTerms(article.description?.substring(0, 100) || 'Lire la suite...')}</p>
                    <time>${formatDate(article.publishedAt)}</time>
                </div>
            </a>
        `).join('');

    } catch (error) {
        console.error("[ERREUR] fetchBretonNews:", error);
        container.innerHTML = `
            <div style="grid-column: 1/-1; text-align: center; color: #d32f2f;">
                <p>Probl√®me de chargement des actualit√©s</p>
                <small>${error.message}</small>
                <button onclick="window.location.reload()" 
                        style="margin-top: 10px; padding: 5px 10px; background: #1e6f8c; color: white; border: none; border-radius: 4px;">
                    R√©essayer
                </button>
            </div>
        `;
    }
}

function highlightBretonTerms(text) {
    if (!text) return '';
    return text.replace(/(Bretagne|Breton|Rennes|Brest|Quimper|Vannes|Saint-Brieuc|Lorient|Morbihan|Finist√®re|C√¥tes-d'Armor|Ille-et-Vilaine)/gi, 
        '<span style="color: #1e6f8c; font-weight:600">$1</span>');
}

function formatDate(dateString) {
    try {
        return new Date(dateString).toLocaleDateString('fr-FR', {
            day: 'numeric',
            month: 'long',
            year: 'numeric'
        });
    } catch {
        return '';
    }
}
</script>

<style>
/* Styles garantis */
#news-results {
    display: grid !important;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)) !important;
    gap: 20px !important;
    padding: 0 15px !important;
}

.news-card {
    display: flex !important;
    flex-direction: column !important;
    height: 100% !important;
    border-radius: 8px !important;
    overflow: hidden !important;
    box-shadow: 0 3px 6px rgba(0,0,0,0.1) !important;
    transition: transform 0.2s, box-shadow 0.2s !important;
    text-decoration: none !important;
    color: inherit !important;
    background: white !important;
    border: 1px solid #d4e6f1 !important;
}

.news-image-container {
    position: relative !important;
    width: 100% !important;
    padding-top: 100% !important;
    overflow: hidden !important;
}

.news-image, .news-image-placeholder {
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important;
}

/* ... (garder le reste des styles tels quels) ... */
</style>
{% endblock %}
