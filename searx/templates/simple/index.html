{% extends "simple/base.html" %}

{% block content %}
<div class="index">
  <div class="logo-container" style="text-align: center;">
    <img src="/static/themes/simple/img/logolusk240.png" alt="Lusk.bzh" class="logo-lusk">
  </div>
  <div class="title custom-title" style="text-align: center; margin-top: 10px;">
    <h1>Lusk.bzh</h1>
    <p class="subtitle">Ce que vous cherchez ne regarde que vous.</p>
  </div>
  {% include 'simple/simple_search.html' %}
  
  <!-- Module d'actualités avec vignettes carrées -->
  <div id="news-container" style="margin: 30px auto; max-width: 900px;">
    <h2 style="text-align: center; margin-bottom: 25px; font-size: 1.5rem;">Actualités Bretonnes</h2>
    <div id="news-results" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; padding: 0 15px;"></div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const apiKey = '2a28af6c4ebc58d5beba1fc150c105eb';
    if (apiKey) {
        console.log("Initialisation du module d'actualités...");
        fetchBretonNews(apiKey);
    }
});

async function fetchBretonNews(apiKey) {
    const container = document.getElementById('news-results');
    if (!container) {
        console.error("ERREUR: Élément #news-results introuvable");
        return;
    }

    try {
        container.innerHTML = `
            <div style="grid-column: 1/-1; text-align: center;">
                <div class="news-loader"></div>
                <p>Recherche des dernières actualités bretonnes...</p>
            </div>
        `;

        const query = encodeURIComponent("Bretagne OR (Rennes AND actualité) OR Finistère OR Morbihan");
        const response = await fetch(`https://gnews.io/api/v4/top-headlines?token=${apiKey}&lang=fr&q=${query}`);
        
        console.debug("Réponse API:", response);

        if (!response.ok) {
            throw new Error(`Erreur HTTP: ${response.status}`);
        }

        const data = await response.json();
        console.log("Données reçues:", data);

        if (!data.articles || data.articles.length === 0) {
            container.innerHTML = `
                <div style="grid-column: 1/-1; text-align: center; padding: 20px;">
                    <p>Aucune actualité bretonne trouvée aujourd'hui.</p>
                    <small>Essayez de rafraîchir la page ou revenez plus tard.</small>
                </div>
            `;
            return;
        }

        const bretonArticles = data.articles.filter(article => 
            article.title && /Bretagne|Breton|Rennes|Brest|Quimper|Vannes|Saint-Brieuc|Lorient|Morbihan|Finistère|Côtes-d'Armor|Ille-et-Vilaine/i.test(article.title)
        );

        if (bretonArticles.length === 0) {
            container.innerHTML = `
                <div style="grid-column: 1/-1; text-align: center;">
                    <p>Nous n'avons pas trouvé d'actualités locales.</p>
                    <button onclick="fetchBretonNews('${apiKey}')" 
                            style="margin-top: 10px; padding: 5px 10px; background: #1e6f8c; color: white; border: none; border-radius: 4px;">
                        Réessayer
                    </button>
                </div>
            `;
            return;
        }

        container.innerHTML = bretonArticles.slice(0, 6).map(article => `
            <a href="${article.url}" target="_blank" rel="noopener noreferrer" class="news-card">
                <div class="news-image-container">
                    ${article.image ? `<img src="${article.image}" alt="${article.title}" loading="lazy">` : ''}
                </div>
                <div class="news-content">
                    <h3>${article.title}</h3>
                    <p>${article.description?.substring(0, 100) || 'Lire la suite...'}</p>
                    <small>${new Date(article.publishedAt).toLocaleDateString('fr-FR')}</small>
                </div>
            </a>
        `).join('');

    } catch (error) {
        console.error("Échec du chargement des actualités:", error);
        container.innerHTML = `
            <div style="grid-column: 1/-1; text-align: center; color: #d32f2f;">
                <p>Service temporairement indisponible</p>
                <small>${error.message}</small>
                <button onclick="fetchBretonNews('${apiKey}')" 
                        style="margin-top: 10px; padding: 5px 10px; background: #1e6f8c; color: white; border: none; border-radius: 4px;">
                    Réessayer
                </button>
            </div>
        `;
    }
}
</script>

<style>
.news-loader {
    border: 3px solid #f3f3f3;
    border-top: 3px solid #1e6f8c;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    animation: spin 1s linear infinite;
    margin: 0 auto 10px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
{% endblock %}
